<transformalize>

  <processes>
    <add name="Recipe" mode="@(Mode)" parallel="false" pipeline-threading="SingleThreaded">

      <connections>
        <add name="input" provider="postgresql" port="5432" database="MyDD" user="postgres" password="*" />
        <add name="output" database="TflMyDD" />
      </connections>

      <actions>
        <add action="tfl" mode="@(Mode)" file="c:\Code\MyDD\mydd\tfl\recipe_tags.xml?Mode=@(Mode)" before="true" after="false" />

        <add action="tfl" mode="@(Mode)" url="C:\Code\mydd\mydd\tfl\recipe_steps_to_xml.xml?Mode=@(Mode)" before="true" after="false" />
        <add action="tfl" mode="@(Mode)" url="C:\Code\mydd\mydd\tfl\recipe_steps_add.xml?Mode=@(Mode)" before="true" after="false" />
        <add action="tfl" mode="@(Mode)" url="C:\Code\mydd\mydd\tfl\recipe_steps_flat.xml?Mode=@(Mode)" before="true" after="false" />
        
        <add action="tfl" mode="@(Mode)" url="C:\Code\mydd\mydd\tfl\recipe_ingredients_to_xml.xml?Mode=@(Mode)" before="true" after="false" />
        <add action="tfl" mode="@(Mode)" url="C:\Code\mydd\mydd\tfl\recipe_ingredients_add.xml?Mode=@(Mode)" before="true" after="false" />
        <add action="tfl" mode="@(Mode)" url="C:\Code\mydd\mydd\tfl\recipe_ingredients_flat.xml?Mode=@(Mode)" before="true" after="false" />

      </actions>

      <entities>
        <add name="app_recipe" alias="Recipe" prefix="recipe_" delete="true" version="modified">
          <fields>
            <add name="id" type="int32" primary-key="true" ></add>
            <add name="author_id" type="int32" label="author id" ></add>
            <add name="name" length="512" ></add>
            <add name="description" length="max" t="trim()" />
            <add name="servings" type="int32" ></add>
            <add name="prep_time" type="int32" label="prep time" ></add>
            <add name="cook_time" type="int32" label="cook time" ></add>
            <add name="difficulty" type="int16" ></add>
            <add name="inspiration" length="512" ></add>
            <add name="created" type="datetime" ></add>
            <add name="modified" type="datetime" ></add>
          </fields>
          <calculated-fields>
            <add name="recipe_name_slug" length="512" t="copy(name).slugify()" />
          </calculated-fields>
        </add>
        <add name="app_person" alias="Author" prefix="author_" version="modified" >
          <fields>
            <add name="id" type="int32" primary-key="true" />
            <add name="first" length="128" />
            <add name="last" length="128" />
            <add name="avatar" length="200" />
            <add name="bio" length="max" />
            <add name="created" type="datetime" />
            <add name="modified" type="datetime" />
          </fields>
          <calculated-fields>
            <add name="author_full_name" length="128" t="join( ,first,last)" />
          </calculated-fields>
        </add>
        <add name="RecipeTagsStar" connection="output" alias="RecipeTags" version="recipe_tags_version" group="true">
          <fields>
            <add name="TflUpdate" alias="recipe_tags_version" type="datetime" label="Tfl Update" aggregate="max" />
            <add name="recipe_tags_recipe_id" type="int32" primary-key="true" aggregate="group" />
            <add name="tag_name" alias="tags" length="255" label="tag name" aggregate="join" t="trim()"/>
          </fields>
        </add>
        <add name="RecipeStepsFlatRecipeStepsAddElement" connection="output" alias="Steps" >
          <fields>
            <add name="id" alias="step_recipe_id" type="int32" label="recipe id" primary-key="true"/>
            <add name="content" alias="step_content" length="max"/>
          </fields>
        </add>
        <add name="RecipeIngredientsFlatRecipeIngredientsAddElement" connection="output" alias="Ingredients" >
          <fields>
            <add name="id" alias="ingredient_recipe_id" type="int32" label="recipe id" primary-key="true"/>
            <add name="content" alias="ingredient_content" length="max"/>
          </fields>
        </add>
      </entities>

      <relationships>
        <add left-entity="Recipe" left-field="author_id" right-entity="Author" right-field="author_id" />
        <add left-entity="Recipe" left-field="recipe_id" right-entity="RecipeTags" right-field="recipe_tags_recipe_id" />
        <add left-entity="Recipe" left-field="recipe_id" right-entity="Steps" right-field="step_recipe_id" />
        <add left-entity="Recipe" left-field="recipe_id" right-entity="Ingredients" right-field="ingredient_recipe_id" />
      </relationships>
    </add>
  </processes>
</transformalize>